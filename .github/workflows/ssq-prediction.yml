#name: SSQ LSTM Prediction

#on:
  schedule:
    # å‘¨ä¸€ã€å‘¨ä¸‰ã€å‘¨äº”åŒ—äº¬æ—¶é—´6:00 (UTC+8, æ‰€ä»¥UTCæ—¶é—´æ˜¯22:00å‰ä¸€å¤©)
    - cron: '0 22 * * 0,2,4'  # UTCæ—¶é—´å‘¨æ—¥ã€å‘¨äºŒã€å‘¨å››22:00
  #workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  PYTHON_VERSION: '3.9'
  TZ: Asia/Shanghai

jobs:
  predict:
    runs-on: ubuntu-latest
    timeout-minutes: 60  # è®¾ç½®è¶…æ—¶æ—¶é—´
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•
        
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y --no-install-recommends \
          build-essential \
          pkg-config \
          python3-dev
        
    - name: Upgrade pip and install dependencies
      run: |
        python -m pip install --upgrade pip wheel setuptools
        pip install --no-cache-dir -r requirements.txt
        
    - name: Verify installation
      run: |
        python -c "import tensorflow as tf; print('TensorFlow version:', tf.__version__)"
        python -c "import pandas as pd; print('Pandas version:', pd.__version__)"
        python -c "import numpy as np; print('NumPy version:', np.__version__)"
        
    - name: Create necessary directories
      run: |
        mkdir -p data models prediction_history
        chmod 755 data models prediction_history
        
    - name: Set up environment
      run: |
        echo "GITHUB_ACTIONS=true" >> $GITHUB_ENV
        echo "TF_CPP_MIN_LOG_LEVEL=2" >> $GITHUB_ENV
        echo "PYTHONUNBUFFERED=1" >> $GITHUB_ENV
        
    - name: Run SSQ LSTM Prediction System
      env:
        WXPUSHER_APP_TOKEN: ${{ secrets.WXPUSHER_APP_TOKEN }}
        WXPUSHER_USER_UIDS: ${{ secrets.WXPUSHER_USER_UIDS }}
        WXPUSHER_TOPIC_IDS: ${{ secrets.WXPUSHER_TOPIC_IDS }}
      run: |
        echo "å¼€å§‹è¿è¡ŒåŒè‰²çƒLSTMé¢„æµ‹ç³»ç»Ÿ..."
        echo "æ£€æŸ¥å¾®ä¿¡æ¨é€é…ç½®..."
        if [ -z "$WXPUSHER_APP_TOKEN" ]; then
          echo "::notice::ä½¿ç”¨é»˜è®¤å¾®ä¿¡æ¨é€Tokenï¼ˆç”¨æˆ·çœŸå®é…ç½®ï¼‰"
        else
          echo "::notice::ä½¿ç”¨è‡ªå®šä¹‰WXPUSHER_APP_TOKENé…ç½®"
        fi
        python -u ssq_automation.py
        
    - name: Check output files
      run: |
        echo "æ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶..."
        ls -la data/ || echo "data/ ç›®å½•ä¸å­˜åœ¨æˆ–ä¸ºç©º"
        ls -la models/ || echo "models/ ç›®å½•ä¸å­˜åœ¨æˆ–ä¸ºç©º"
        ls -la prediction_history/ || echo "prediction_history/ ç›®å½•ä¸å­˜åœ¨æˆ–ä¸ºç©º"
        
    - name: Clean up old files
      run: |
        echo "æ¸…ç†æ—§æ–‡ä»¶..."
        # åªä¿ç•™æœ€è¿‘10ä¸ªé¢„æµ‹æŠ¥å‘Š
        if [ -d "prediction_history" ] && [ "$(ls -A prediction_history)" ]; then
          cd prediction_history
          ls -t *.csv 2>/dev/null | tail -n +11 | xargs -r rm -f
          cd ..
        fi
        
        # æ¸…ç†è®­ç»ƒå›¾ç‰‡
        rm -f training_history.png
        
    - name: Commit and push if changes
      run: |
        git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
        if git diff --quiet && git diff --staged --quiet; then
          echo "æ²¡æœ‰éœ€è¦æäº¤çš„å˜æ›´"
        else
          echo "å‘ç°å˜æ›´ï¼Œå¼€å§‹æäº¤..."
          git add -A
          git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–°åŒè‰²çƒé¢„æµ‹ $(date '+%Y-%m-%d %H:%M:%S CST')" || exit 0
          
          # æ¨é€å˜æ›´ï¼Œå¦‚æœå¤±è´¥åˆ™é‡è¯•
          for i in {1..3}; do
            if git push; then
              echo "æ¨é€æˆåŠŸ"
              break
            else
              echo "æ¨é€å¤±è´¥ï¼Œé‡è¯• $i/3..."
              sleep 5
            fi
          done
        fi 
